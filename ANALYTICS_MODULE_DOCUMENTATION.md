# Custom Analytics Module Documentation

## Overview

The Custom Analytics Module is a comprehensive, self-hosted analytics solution that tracks and visualizes system-wide usage data. It collects data from internal logs and events generated by the platform, storing everything in a dedicated MongoDB schema optimized for read queries.

## Features

### âœ… Core Features

1. **Event Tracking**
   - Records created, updated, deleted
   - PDFs generated and downloaded
   - Google Drive uploads and connections
   - Page visits across all modules
   - User logins and logouts
   - Report generation and viewing
   - System events (backups, notifications)

2. **Analytics Dashboard**
   - Summary cards with key metrics
   - Line charts for daily trends
   - Bar charts for page visits
   - Pie charts for status distribution
   - Recent activities table
   - Filterable by date range, event type, and page

3. **Database Design**
   - `AnalyticsEvent` model for individual events
   - `DailySummaryReport` model for aggregated data
   - Optimized indexes for fast queries
   - Date-based partitioning for efficient filtering

4. **Access Control**
   - Admin-only access
   - RBAC validation on all endpoints
   - Secure event logging

## Database Schema

### AnalyticsEvent Model

Stores individual analytics events:

```javascript
{
  eventType: String (enum),
  userId: ObjectId,
  userModel: String,
  userName: String,
  userEmail: String,
  userRole: String,
  pageName: String,
  metadata: Object,
  ipAddress: String,
  userAgent: String,
  date: Date,
  year: Number,
  month: Number,
  week: Number,
  day: Number,
  timestamps: true
}
```

**Event Types:**
- `record_created`, `record_updated`, `record_deleted`, `record_locked`, `record_unlocked`
- `pdf_generated`, `pdf_downloaded`
- `drive_uploaded`, `drive_connected`, `drive_disconnected`
- `page_visit`
- `user_login`, `user_logout`, `user_created`, `user_updated`, `user_deleted`
- `report_generated`, `report_viewed`
- `backup_created`, `backup_restored`
- `notification_sent`

### DailySummaryReport Model

Stores aggregated daily statistics (for future use):

```javascript
{
  date: Date,
  recordsCreated: Number,
  recordsUpdated: Number,
  pdfsGenerated: Number,
  driveUploads: Number,
  activeUsers: Number,
  pageVisits: Map,
  // ... more aggregated fields
}
```

## API Endpoints

### Admin Endpoints (Protected)

#### GET /api/admin/analytics/overview
Get summary statistics for the analytics dashboard.

**Query Parameters:**
- `range` (optional): `7d`, `30d`, `90d`, `1y` (default: `30d`)

**Response:**
```json
{
  "success": true,
  "overview": {
    "totalRecords": 150,
    "recordsCreatedInRange": 25,
    "totalPDFsGenerated": 45,
    "totalDriveUploads": 30,
    "activeCounselorsThisWeek": 8,
    "totalPageVisits": 1200,
    "activeUsers": 12
  },
  "dateRange": {
    "start": "2024-01-01T00:00:00.000Z",
    "end": "2024-01-31T23:59:59.999Z",
    "range": "30d"
  }
}
```

#### GET /api/admin/analytics/page-visits
Get page visit analytics.

**Query Parameters:**
- `range` (optional): Date range
- `pageName` (optional): Filter by specific page

**Response:**
```json
{
  "success": true,
  "pageVisits": {
    "byPage": [
      { "pageName": "Dashboard", "count": 450 },
      { "pageName": "Records Page", "count": 320 }
    ],
    "daily": [
      { "date": "2024-01-15", "count": 45 },
      { "date": "2024-01-16", "count": 52 }
    ]
  }
}
```

#### GET /api/admin/analytics/events
Get analytics events with filtering.

**Query Parameters:**
- `range` (optional): Date range
- `eventType` (optional): Filter by event type
- `userId` (optional): Filter by user ID
- `page` (optional): Page number (default: 1)
- `limit` (optional): Items per page (default: 50)

#### GET /api/admin/analytics/record-status-distribution
Get distribution of record statuses (Ongoing, Completed, Referred).

#### GET /api/admin/analytics/daily-records
Get daily records created (for line chart).

**Query Parameters:**
- `range` (optional): Date range

### Public Endpoint

#### POST /api/analytics/log-event
Log an analytics event (used by frontend).

**Request Body:**
```json
{
  "eventType": "page_visit",
  "pageName": "Dashboard",
  "metadata": {}
}
```

**Response:**
```json
{
  "success": true,
  "message": "Event logged successfully"
}
```

## Frontend Installation

### Install Chart.js (Optional but Recommended)

For better chart visualizations, install Chart.js:

```bash
cd frontend
npm install chart.js react-chartjs-2
```

Then update the Analytics.jsx component to use Chart.js components instead of the placeholder SVG charts.

## Integrating Analytics Logging

### Example: Log Record Creation

```javascript
import { logRecordCreated } from "../utils/analyticsLogger.js";

export const createRecord = async (req, res) => {
  try {
    // ... existing record creation logic ...
    
    const record = new Record({ ... });
    await record.save();
    
    // Log analytics event
    await logRecordCreated(req.user, record._id, {
      clientName: record.clientName,
      sessionNumber: record.sessionNumber,
    });
    
    res.status(201).json({ success: true, record });
  } catch (error) {
    // ... error handling ...
  }
};
```

### Example: Log Page Visit

```javascript
import { logPageVisit } from "../utils/analyticsLogger.js";

// In your page component or middleware
useEffect(() => {
  const logVisit = async () => {
    await axios.post(`${BASE_URL}/api/analytics/log-event`, {
      eventType: "page_visit",
      pageName: "Dashboard",
    });
  };
  logVisit();
}, []);
```

### Example: Log PDF Generation

```javascript
import { logPDFGenerated } from "../utils/analyticsLogger.js";

export const generatePDF = async (req, res) => {
  try {
    // ... PDF generation logic ...
    
    // Log analytics event
    await logPDFGenerated(req.user, {
      recordId: record._id.toString(),
      fileName: pdfFileName,
    });
    
    res.status(200).json({ success: true, pdfUrl });
  } catch (error) {
    // ... error handling ...
  }
};
```

## Integration Checklist

To fully integrate analytics into your application:

- [ ] Add logging to record creation controller
- [ ] Add logging to record update controller
- [ ] Add logging to record lock/unlock controllers
- [ ] Add logging to PDF generation controller
- [ ] Add logging to Google Drive upload controller
- [ ] Add logging to login/logout controllers
- [ ] Add page visit logging to frontend pages
- [ ] Add logging to report generation
- [ ] Add logging to backup operations
- [ ] Install Chart.js for better visualizations

## Usage Guide

### Accessing Analytics Dashboard

1. Log in as an admin
2. Navigate to Admin Dashboard
3. Click "Analytics" in the sidebar
4. View summary cards, charts, and recent activities
5. Use filters to customize the view

### Filtering Analytics

- **Date Range**: Select from dropdown (7d, 30d, 90d, 1y)
- **Event Type**: Filter by specific event types
- **Page**: Filter by specific pages/modules

## Performance Considerations

1. **Indexes**: All frequently queried fields are indexed
2. **Date Partitioning**: Events are stored with date fields (year, month, week, day) for efficient filtering
3. **Asynchronous Logging**: Analytics events are logged asynchronously to avoid blocking requests
4. **Pagination**: Event lists are paginated to handle large datasets

## Security

- All admin endpoints require authentication via `protectAdmin` middleware
- Event logging includes IP address and user agent for security auditing
- Only admins can view analytics data
- Events are logged server-side to prevent manipulation

## Future Enhancements

1. **Export Functionality**: Export analytics data to CSV or PDF
2. **Automated Reports**: Weekly email summaries
3. **Heatmaps**: Visual heatmaps of system activity
4. **Real-time Updates**: WebSocket-based real-time analytics
5. **Custom Dashboards**: Allow admins to create custom dashboards
6. **Data Retention**: Automatic cleanup of old analytics data
7. **Advanced Filters**: More granular filtering options
8. **Comparison Views**: Compare analytics across date ranges

## Troubleshooting

### Events Not Showing

1. Check that analytics logging is integrated into controllers
2. Verify that events are being logged to the database
3. Check date range filters
4. Ensure user has admin permissions

### Charts Not Rendering

1. Install Chart.js: `npm install chart.js react-chartjs-2`
2. Replace placeholder chart components with Chart.js components
3. Check browser console for errors

### Performance Issues

1. Check database indexes are created
2. Reduce date range for large datasets
3. Consider implementing daily summary reports for faster queries

## Support

For issues or questions about the Analytics Module, contact the development team or refer to the main project documentation.

